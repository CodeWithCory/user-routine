<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test SPA Check</title>
</head>

<body>

  <main>
    <br><br><br>
    <h1>Test Page for SPA Check</h1>
    <p id="progress">Running tests...</p>

    <h3>Mock Application</h3>
    <p>Click the button to duplicate some text.</p>
    <label>Text:</label>
    <input type="text">
    <label>Count:</label>
    <input type="number" min="0" max="9999">
    <button class="duplicate">Duplicate!</button>
    <pre></pre>
    <br><br>
    <button class="process"><span>&#128337;</span> Simulate long process</button><p class="output"></p>

    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>

    <h3>Here's another section</h3>
    <p id="far-down">It's really far down... Can you see me?</p>
    <br><br><br><br><br><br><br><br><br><br><br><br>
  </main>

  <script>
    /* Mock app functionality */
    document.querySelector('button.duplicate').addEventListener('click', () => {
      const outputArea = document.querySelector('pre');
      outputArea.textContent = '';
      const text = document.querySelector('input[type="text"]').value;
      const count = document.querySelector('input[type="number"]').value;
      for (let i = 0; i < Number(count); i++) {
        outputArea.textContent += (text + " ")
      }
    });
    document.querySelector('button.process').addEventListener('click', () => {
      document.querySelector('p.output').innerHTML = '';
      setTimeout(() => {
        const p = document.createElement('p');
        document.querySelector('p.output').appendChild(p);
      }, 1200)
      setTimeout(() => {
        const p = document.querySelector('p.output>p');
        p.textContent = " Process complete!";
      }, 2400)
    });
  </script>

  <style>
    main {
      font-family: Arial, Helvetica, sans-serif;
    }
    pre {
      font-size: 16px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  
  <script data-tests>
var that={},__awaiter=that&&that.__awaiter||function(t,e,o,a){return new(o||(o=Promise))((function(n,i){function r(t){try{s(a.next(t))}catch(t){i(t)}}function l(t){try{s(a.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,l)}s((a=a.apply(t,e||[])).next())}))};function spaCheck(t,e={}){return __awaiter(that,void 0,void 0,(function*(){const o=[],a=Object.freeze(Object.assign(Object.assign({},{continueOnFailure:!1,globalDelay:500,awaitTimeout:15e3,logCollapse:!1,logResult:!0,logUpdates:!0,message:"",messageShowInDOM:!1,messageStyle:"font-size:24px; padding:10px; z-index:9999; position:fixed; top:0; right:10%; color:black; background-color:rgba(222,222,222,0.8);"}),e)),n=a.message?`[SPA Check] ${a.message}`:"[SPA Check]";let i,r,l=!1,s=!0;return that.main=t=>__awaiter(that,void 0,void 0,(function*(){yield that.messageStart();if(!that.validateInputs(t,e))return that.finish();for(const e of t){if(!s)return that.finish();yield that.sleep(a.globalDelay);try{yield that.do(e)}catch(t){that.error("Unexpected error: "+t.message)}}return that.finish()})),that.finish=()=>{const t=!l,e={success:t,log:o,message:a.message};return that.log(`Done, success: ${t}`),that.messageEnd(e),e},that.do=t=>__awaiter(that,void 0,void 0,(function*(){if("string"==typeof t)yield that.doActionString(t);else if("function"==typeof t)try{yield t(),that.log("Ran provided function")}catch(e){that.error("Error running provided function",e+"; function: "+t.toString())}else that.error("Action is not of type string or function, got",typeof t)})),that.doActionString=t=>__awaiter(that,void 0,void 0,(function*(){const e=t.substring(0,3);if("nav"===e){const e=t.split(" ")[1];e&&"#"===e[0]?(window.location.href=e,that.log(`Navigated to ${e}`)):that.error("Unexpected nav action, got",t)}else if("cli"===e){const[e,o,a]=that.argSplitComplex(t),n=that.getTargetText(o,a);if(a){const t=document.querySelectorAll(o);r=void 0,that.findClickableElementWithTextRecursive(t,a),r?(r.click(),that.log(`Clicked text '${a}' inside ${o} (clicked on ${r.tagName.toLowerCase()})`)):that.error("Could not find selector to click",n),r=void 0}else{const t=that.select(o);if(!t)return;t.click(),that.log(`Clicked ${o}`)}}else if("exi"===e){const[e,o,a]=that.argSplitComplex(t),n=that.getTargetText(o,a);let i=!1;if(a){const t=document.querySelectorAll(o);for(const e of t)if(that.checkIfElementContainsText(e,a)){i=!0;break}}else{document.querySelector(o)&&(i=!0)}i?that.log(`Did exist: ${n}`):that.error("Did not exist",n)}else if("val"===e){const[e,o,a]=that.argSplit(t);if(!that.select(o))return;that.select(o).value=a,that.log(`Set the value of ${o} to ${a}`)}else if("wri"===e||"app"===e){const[o,a,n]=that.argSplit(t),i=that.select(a);if(!i)return;"wri"===e?(i.textContent=n,that.log(`Wrote '${n}' over ${a}`)):(i.textContent+=n,that.log(`Appended '${n}' to ${a}`))}else if("log"===e){const[e,o]=t.split(/ (.*)/s);that.log(o)}else if("wai"===e){const[e,o]=t.split(" ");that.log(`Waiting ${Number(o)/1e3} second(s)`),yield that.sleep(Number(o))}else if("awa"===e){const[e,o,n]=that.argSplitComplex(t),i=a.awaitTimeout/a.globalDelay;let r=!1;const l=that.getTargetText(o,n);that.log(`Awaiting ${l}...`);for(let t=0;t<i;t++){if(n){const t=Array.from(document.querySelectorAll(o));for(const e of t)if(e&&e.textContent&&e.textContent.toLowerCase().includes(n.toLowerCase())){r=!0;break}}else{document.querySelector(o)&&(r=!0)}if(r)break;yield that.sleep(a.globalDelay)}r?that.log(`...Found ${l}`):that.error(`Timed out after ${a.awaitTimeout/1e3} second(s) awaiting`,l)}else""===t||that.error("Action string keyword not recognized, got",t)})),that.select=t=>{const e=document.querySelector(t);return e||that.error("CSS Selector not found",t),e},that.findClickableElementWithTextRecursive=(t,e)=>{for(const o of t){if(!that.checkIfElementContainsText(o,e))continue;that.checkIfElementIsClickable(o)&&(r=o);const t=Array.from(o.childNodes).filter((t=>{if(that.checkIfElementIsClickable(t))return t}));that.findClickableElementWithTextRecursive(t,e)}},that.checkIfElementIsClickable=t=>t.click&&"SCRIPT"!==t.tagName,that.checkIfElementContainsText=(t,e)=>{const o=e.toLowerCase(),a=t.textContent&&t.textContent.toLowerCase().includes(o),n="string"==typeof t.value&&t.value.toLocaleLowerCase().includes(o);return a||n},that.getTargetText=(t,e)=>`'${t}'`+(e?` containing text '${e}'`:""),that.argSplit=t=>{const e=t.split(/ ([^\s]+) (.*)/s);return e.length<3&&that.error(`Unexpected ${e[0]} input with data, got:`,t),e},that.argSplitComplex=t=>{const e=t.split(" ");return e.length>2?that.argSplit(t):e},that.messageStart=()=>__awaiter(that,void 0,void 0,(function*(){yield that.sleep(0),a.logUpdates&&(a.logCollapse?console.groupCollapsed(n):console.group(n)),i=a.messageShowInDOM&&a.message?that.displayMessageInDOM(a.message,a.messageStyle):void 0})),that.messageEnd=t=>{i&&i.remove();const e=a.logUpdates?"":n;a.logResult&&console.log(`${e} Result:`,t),a.logUpdates&&console.groupEnd()},that.displayMessageInDOM=(t,e)=>{var o;const a=document.createElement("p");return a.textContent=t,a.setAttribute("style",e),null===(o=document.querySelector("body"))||void 0===o||o.appendChild(a),a},that.validateInputs=(t,e)=>{let o=!0;return void 0===t?(o=!1,that.error("Missing required argument Action List","",!1)):Array.isArray(t)||(o=!1,that.error("Action list argument is not an Array","",!1)),void 0===e||"object"==typeof e&&!Array.isArray(e)||(o=!1,that.error("Options argument is not an Object","",!1)),o},that.log=t=>{o.push(t);const e=`* ${t}`;a.logUpdates&&console.log(e)},that.error=(t,e,n=a.continueOnFailure)=>{l=!0;let i=`FAIL: ${t}`+(e?`: '${e}'`:"");n?i+=". Continuing execution.":(s=!1,i+=". Halting execution."),o.push(i),console.error(i)},that.sleep=t=>new Promise((e=>setTimeout(e,t))),yield that.main(t)}))}
async function runSpaChecks() {
  await spaCheck([
    'wait 500',
    'val input[type="text"] Hello, world!',
    'val input[type="number"] 20',
    'click button',
    'exists pre hello',
    'nav #far-down',
    'write #far-down Back up we go!',
    'exists body',
    'nav #',
    () => { console.log('This is a regular function') },
    'log Next is an async function',
    async () => { await new Promise(resolve => setTimeout(() => { resolve() }, 1000)) },
    'click button long process',
    'await p.output>p',
    'await p.output process complete',
  ], { message: 'Testing features', messageShowInDOM: true, globalDelay: 250 });

  await spaCheck([
    'click does-not-exist',
    'invalidkeyword test',
    () => { throw new Error('This function should error') },
    'await does-not-exist',
    'await body>main this text should not exist anywhere'
  ], {
    message: 'Testing error handling (expect success: false)', messageShowInDOM: true,
    continueOnFailure: true, globalDelay: 100, awaitTimeout: 250,
  });

  await spaCheck([
    'log Should halt after the following error',
    'click does-not-exist',
    'write h1 This text should not appear',
  ], { message: 'Testing graceful fail (expect success: false)', messageShowInDOM: true });

  await spaCheck([
    'append #progress  Done! Check the browser console for results.',
  ], { globalDelay: 0, logUpdates: false, logResult: false });

  console.log('Done! See above for results.');
}
runSpaChecks();</script>
</body>

</html>
