<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Dry-Run</title>
</head>

<body>

  <main>
    <br><br><br>
    <h1>Test Page for Dry-Run</h1>
    <p id="progress">Running tests...</p>

    <h3>Mock Application</h3>
    <p>Click the button to duplicate some text.</p>
    <label>Text:</label>
    <input type="text">
    <label>Count:</label>
    <input type="number" min="0" max="9999">
    <button class="duplicate">Duplicate!</button>
    <pre></pre>
    <br><br>
    <button class="process"><span>&#128337;</span> Simulate long process</button>
    <div class="output"></div>
    <div><div><div><div class="test"></div></div></div></div>

    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    <br><br><br><br><br><br><br><br><br><br><br><br>

    <h3>Here's another section</h3>
    <p id="far-down">It's really far down... Can you see me?</p>
    <br><br><br><br><br><br><br><br><br><br><br><br>
  </main>

  <script>
    /* Mock app functionality */
    document.querySelector('button.duplicate').addEventListener('click', () => {
      const outputArea = document.querySelector('pre');
      outputArea.textContent = '';
      const text = document.querySelector('input[type="text"]').value;
      const count = document.querySelector('input[type="number"]').value;
      for (let i = 0; i < Number(count); i++) {
        outputArea.textContent += (text + " ")
      }
    });
    document.querySelector('button.process').addEventListener('click', () => {
      document.querySelector('.output').innerHTML = '';
      const p = document.createElement('p');
      p.textContent = 'Processing...';
      p.style = 'display: inline-block; width: 150px; background-color: lightgray; padding: 10px;'
      document.querySelector('.output').appendChild(p);
      setTimeout(() => {
        p.textContent = 'Almost there...'
      }, 3000)
      setTimeout(() => {
        p.textContent = 'Process complete!';
      }, 6000)
    });
  </script>

  <style>
    main {
      font-family: Arial, Helvetica, sans-serif;
    }
    pre {
      font-size: 16px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  
  <script data-tests>
(()=>{"use strict";var e={d:(o,t)=>{for(var i in t)e.o(t,i)&&!e.o(o,i)&&Object.defineProperty(o,i,{enumerable:!0,get:t[i]})},o:(e,o)=>Object.prototype.hasOwnProperty.call(e,o),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};e.r(o),e.d(o,{dryRun:()=>i});var t=function(e,o,t,i){return new(t||(t=Promise))((function(n,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function d(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(s,d)}a((i=i.apply(e,o||[])).next())}))};function i(e,o={}){return t(this,void 0,void 0,(function*(){let i;const n={awaitTimeout:15e3,continueOnFailure:!1,displayMessage:!0,displayProgress:!0,displaySpeed:1,globalDelay:500,logCollapse:!1,logProgress:!0,logResult:!0,message:"Dry-Run",overrideCss:"",separator:" ",tutorialMode:!1},r=[];let s,d,a,l=!1,c=!0;const u={arrow:void 0,arrowShadow:void 0,focusBox:void 0,message:void 0,style:void 0,tooltip:void 0,tooltipShadow:void 0};s=Object.freeze(Object.assign(Object.assign({},n),o)),d=s.message?`[Dry-Run] ${s.message}`:"[Dry-Run]",yield function(){return t(this,void 0,void 0,(function*(){(s.displayMessage||s.displayProgress)&&function(){var e;t(this,void 0,void 0,(function*(){u.style=document.createElement("style"),u.style.textContent="\n    body > .dry-run-message {\n      font: 20px Georgia;\n      padding: 18px 12px 6px 12px;\n      z-index: 9999;\n      position: fixed;\n      top: 0;\n      right: 10%;\n      color: black;\n      background-color: rgba(250,250,250,0.8);\n      text-align: right;\n      border-radius: 0 0 12px 12px;\n      max-width: 80vw;\n      overflow: hidden;\n      white-space: nowrap;\n      text-overflow: ellipsis;\n      border: 2px solid rgb(180,180,180);\n      border-top: 0;\n    }\n    body > .dry-run-message>.dry-run-attribution {\n      font-size: 12px;\n      color: dimgray;\n    }\n    body > .dry-run-focus-box {\n      z-index: 9997;\n      visibility: hidden;\n      position: absolute;\n      background-color: rgba(255,255,255,0.2);\n      border: 2px solid white;\n      box-shadow: 0 0 0 2px rgb(0,0,0);\n    }\n    body > .dry-run-tooltip {\n      z-index: 9999;\n      visibility: hidden;\n      font: 14px Georgia;\n      position: absolute;\n      background-color: rgb(245,245,245);\n      color: black;\n      text-align: center;\n      padding: 10px;\n      border-radius: 10px;\n      max-width: 200px;\n    }\n    body > .dry-run-tooltip-error {\n      color: darkred;\n    }\n    body > .dry-run-arrow {\n      z-index: 9999;\n      visibility: hidden;\n      width: 0;\n      height: 0;\n      position: absolute;\n      border-left: 10px solid transparent;\n      border-right: 10px solid transparent;\n      border-bottom: 10px solid rgb(245,245,245); \n    }\n    body > .dry-run-arrow-shadow {\n      z-index: 9998;\n      border-left: 14px solid transparent;\n      border-right: 14px solid transparent;\n      border-bottom: 14px solid rgb(180,180,180);\n      margin: -3px 0 0 -4px;\n    }\n    body > .dry-run-tooltip-shadow {\n      z-index: 9998;\n      color: transparent;\n      border: 2px solid rgb(180,180,180);\n      background-color: rgb(180,180,180);\n      margin: -2px 0 0 -2px;\n      border-radius: 12px;\n    }\n    body > .dry-run-fade-in {\n      visibility: visible;\n      animation: dryRunfadeIn 150ms; \n    }\n    body > .dry-run-fade-out {\n      opacity: 0;\n      animation: dryRunfadeOut 150ms; \n    }\n    @keyframes dryRunfadeIn {\n      0% { opacity: 0; }\n      100% { opacity: 1; }\n    }\n    @keyframes dryRunfadeOut {\n      0% { opacity: 1; }\n      100% { opacity: 0; }\n    }\n  ",u.style.textContent+=s.overrideCss,null===(e=h("body"))||void 0===e||e.appendChild(u.style)}))}(),yield P(0),s.logProgress&&(s.logCollapse?console.groupCollapsed(d):console.group(d)),function(e){var o;t(this,void 0,void 0,(function*(){u.message=document.createElement("div");const t=e===n.message?"":'<div class="dry-run-attribution">Dry-Run</div>';u.message.innerHTML=e+t,u.message.classList.add("dry-run-message"),s.displayMessage||(u.message.style.visibility="hidden"),null===(o=h("body"))||void 0===o||o.appendChild(u.message)}))}(s.message)}))}();const p=yield function(e,o){return t(this,void 0,void 0,(function*(){let t=!0;return void 0===e?(t=!1,yield A("Missing required argument Action List","",!1)):Array.isArray(e)||"string"==typeof e||(t=!1,yield A("Action list argument is not an Array or string","",!1)),void 0===o||"object"==typeof o&&!Array.isArray(o)||(t=!1,yield A("Options argument is not an Object","",!1)),t}))}(e,o);if(!p)return S();"string"==typeof e?i=e.split("\n").map((e=>e.trim())):Array.isArray(e)&&(i=e.map((e=>"string"==typeof e?e.trim():e)));for(const e of i){if(!c)return S();yield P(s.globalDelay);try{yield f(e)}catch(e){yield A("Unexpected error: "+e.message)}}return S();function f(e){return t(this,void 0,void 0,(function*(){if("string"==typeof e)yield function(e){return t(this,void 0,void 0,(function*(){const o=e.replace("!","").substring(0,3);if("nav"===o){const o=e.split(s.separator)[1];o&&"#"===o[0]?(yield y((()=>{window.location.href=o}),`Navigating to ${o}`,void 0,!s.tutorialMode),M(`Navigated to ${o}`)):yield A("Unexpected nav action, got",e)}else if("cli"===o){const[o,t,i]=yield C(e),n=x(t,i);if(i){const e=v(t);a=void 0,m(e,i,w),a?(yield y((()=>{a.click()}),`Clicking ${a.tagName.toLowerCase()} with text '${i}'`,a,!s.tutorialMode),M(`Clicked text '${i}' inside ${t} (clicked on ${a.tagName.toLowerCase()})`)):yield A("Could not find selector to click",n),a=void 0}else{const e=yield g(t);if(!e)return;yield y((()=>{e.click()}),`Clicking ${e.tagName.toLowerCase()}`,e,!s.tutorialMode),M(`Clicked ${t}`)}}else if("exi"===o){let[o,t,i]=yield C(e),n=!1;"!"===t[0]&&(t=t.substring(1),n=!0);const r=x(t,i);let d,l=!1;if(i){const e=v(t);a=void 0,m(e,i,w),a&&(d=a,l=!0)}else{const e=h(t);e&&(l=!0,d=e)}l&&!n?(s.tutorialMode||(yield $(d,`Confirmed exists: ${r}`,"info")),s.tutorialMode||(yield L()),M(`Confirmed exists: ${r}`)):l||n?l&&n?(s.tutorialMode||(yield $(d,`Incorrectly exists: ${r}`,"error")),s.tutorialMode||(yield L()),yield A(`Incorrectly exists: ${r}`)):!l&&n&&(s.tutorialMode||(yield $(u.message,`Confirmed does not exist: ${r}`,"info",!0)),s.tutorialMode||(yield L()),M(`Confirmed does not exist: ${r}`)):yield A("Did not exist",r),a=void 0}else if("val"===o){const[o,t,i]=yield k(e),n=yield g(t);if(!n)return;yield y((()=>{n.value=i,n.dispatchEvent(new InputEvent("input"))}),`Filling value of ${n.tagName.toLowerCase()}`,n,!s.tutorialMode),M(`Set the value of ${t} to '${i}'`)}else if("wri"===o||"app"===o){const[t,i,n]=yield k(e),r=yield g(i);if(!r)return;"wri"===o?(yield y((()=>{r.textContent=n}),`Writing over ${i}`,r,!s.tutorialMode),M(`Wrote '${n}' over ${i}`)):(yield y((()=>{r.textContent+=n}),`Appending text to ${i}`,r,!s.tutorialMode),M(`Appended '${n}' to ${i}`))}else if("log"===o){let o,t;" "!==s.separator?[o,t]=e.split(s.separator):[o,t]=e.split(/ (.*)/s),yield y((()=>{M(t)}),`${t}`)}else if("com"===o){const[o,t,i]=yield C(e);if(!i)return void(yield A(`Value was not provided for comment action '${e}'`));const n=h(t);if(!n)return;yield $(n,i,"info"),yield L()}else if("wai"===o){const[o,i]=e.split(s.separator);M(`Waiting ${Number(i)/1e3} second(s)`),yield y((()=>t(this,void 0,void 0,(function*(){yield P(Number(i))}))),`Waiting ${Number(i)/1e3} second(s)`,void 0,!s.tutorialMode)}else if("awa"===o){let[o,t,i]=yield C(e),n=!1;"!"===t[0]&&(t=t.substring(1),n=!0);const r=s.awaitTimeout/s.globalDelay;let d,l=!1;const c=x(t,i);M(`Awaiting ${c}...`);const p=n?`Awaiting ${c} to not exist...`:`Awaiting ${c}...`;s.tutorialMode||(yield $(u.message,p,"info",!0));for(let e=0;e<r;e++){if(i){const e=Array.from(v(t.replace(/>>/g," ")));for(const o of e)if(o&&o.textContent&&o.textContent.toLowerCase().includes(i.toLowerCase())){l=!0,a=void 0,m([o],i,w),d=a;break}}else{const e=h(t);e&&(l=!0,d=e)}if(l&&!n)break;if(!l&&n)break;l=!1,yield P(s.globalDelay)}s.tutorialMode||(yield L()),l&&!n?(s.tutorialMode||(yield $(d,`...Found ${c}`,"info")),s.tutorialMode||(yield L()),M(`...Found ${c}`)):l||n?l&&n?(s.tutorialMode||(yield $(d,`...Timed out awaiting ${c} to not exist`,"error")),s.tutorialMode||(yield L()),yield A(`...Timed out awaiting ${c} to not exist`)):!l&&n&&M(`...${c} disappeared`):yield A(`Timed out after ${s.awaitTimeout/1e3} second(s) awaiting`,c)}else""===e||(yield A("Action string keyword not recognized, got",e))}))}(e);else if("function"==typeof e)try{yield y(e,"Running provided function",void 0,!s.tutorialMode),M("Ran provided function")}catch(o){yield L(),yield A("Error running provided function",o+"; function: "+e.toString())}else yield A("Action is not of type string or function, got",typeof e)}))}function y(e,o,i,n=!0){return t(this,void 0,void 0,(function*(){let t=!1;i||(i=u.message?u.message:document.body,t=!0),n&&(yield $(i,o,"info",t)),yield e(),n&&(yield L())}))}function g(e){return t(this,void 0,void 0,(function*(){const o=h(e);return o||(yield A("CSS Selector not found",e.replace(/>>/g," "))),o}))}function h(e){const o=e.replace(/>>/g," "),t=document.querySelector(o);return t||A("CSS Selector not found",o),t}function v(e){const o=e.replace(/>>/g," "),t=document.querySelectorAll(o);return t||A("CSS Selector not found",o),t}function m(e,o,t=(e=>"SCRIPT"!==e.tagName)){for(const i of e)b(i,o)&&(t(i)&&(a=i),m(Array.from(i.childNodes).filter((e=>{if(t(e))return e})),o,t))}function w(e){return e.click&&"SCRIPT"!==e.tagName}function b(e,o){const t=o.toLowerCase(),i=e.textContent&&e.textContent.toLowerCase().includes(t),n="string"==typeof e.value&&e.value.toLowerCase().includes(t);return i||n}function x(e,o){return`'${e}'`+(o?` containing text '${o}'`:"")}function k(e){return t(this,void 0,void 0,(function*(){if(" "!==s.separator)return e.split(s.separator);const o=e.split(/ ([^\s]+) (.*)/s);return o.length<3&&(yield A(`Unexpected ${o[0]} input with data, got:`,e)),o[1]=o[1].replace(/>>/g," "),o}))}function C(e){return t(this,void 0,void 0,(function*(){const o=e.split(s.separator);return" "!==s.separator?o:o.length>2?yield k(e):(o[1]=o[1].replace(/>>/g," "),o)}))}function S(){return t(this,void 0,void 0,(function*(){!function(){t(this,void 0,void 0,(function*(){for(const e in u)u[e]&&u[e].parentNode&&u[e].remove&&u[e].remove()}))}();const e=!l,o={success:e,log:r,message:s.message};return M(`Done, success: ${e}`),function(e){t(this,void 0,void 0,(function*(){u.message&&u.message.remove(),u.style&&u.style.remove();const o=s.logProgress?"":d;s.logResult&&console.log(`${o} Result:`,e),s.logProgress&&console.groupEnd()}))}(o),o}))}function $(e,o,i="info",n){return t(this,void 0,void 0,(function*(){if(!s.displayProgress)return;const r=document.body.getBoundingClientRect(),d=e.getBoundingClientRect(),a=n?0:window.pageYOffset||e.scrollTop||document.body.scrollTop,l=window.pageXOffset||e.scrollLeft||document.body.scrollLeft;u.focusBox=document.createElement("div"),u.focusBox.classList.add("dry-run-focus-box"),u.arrow=document.createElement("div"),u.arrow.classList.add("dry-run-arrow"),u.tooltip=document.createElement("div"),u.tooltip.classList.add("dry-run-tooltip"),"error"===i&&u.tooltip.classList.add("dry-run-tooltip-error"),u.tooltip.textContent=o.replace(/>>/g," "),document.body.appendChild(u.focusBox),document.body.appendChild(u.arrow),document.body.appendChild(u.tooltip);const c=u.tooltip.getBoundingClientRect().width;let p=d.bottom+10+a,f=d.left+l+d.width/2-10,y=d.left+l+d.width/2-c/2;f<8?f=8:r.right+l-f<20&&(f=r.right+l-20),y<0&&(y=0),n&&(u.focusBox.style.display="none",u.arrow.style.display="none",u.tooltip.style.position="fixed",f-=l,p-=5,y-=l),u.arrow.style.top=String(d.bottom+a+2)+"px",u.arrow.style.left=String(f)+"px",u.tooltip.style.top=String(p+2)+"px",u.tooltip.style.left=String(y)+"px",u.focusBox.style.top=String(d.top+a-2)+"px",u.focusBox.style.left=String(d.left+l-2)+"px",u.focusBox.style.width=String(d.width)+"px",u.focusBox.style.height=String(d.height)+"px",u.arrowShadow=u.arrow.cloneNode(!0),u.tooltipShadow=u.tooltip.cloneNode(!0),u.arrowShadow.classList.add("dry-run-arrow-shadow"),u.tooltipShadow.classList.add("dry-run-tooltip-shadow"),document.body.appendChild(u.arrowShadow),document.body.appendChild(u.tooltipShadow),yield function(e){return t(this,void 0,void 0,(function*(){(function(e){var o=e.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight);return!(o.bottom<0||o.top-t>=0)})(e)||(e.scrollIntoView({behavior:"smooth"}),yield P(700))}))}(e),u.focusBox.classList.add("dry-run-fade-in"),u.arrowShadow.classList.add("dry-run-fade-in"),u.tooltipShadow.classList.add("dry-run-fade-in"),u.arrow.classList.add("dry-run-fade-in"),u.tooltip.classList.add("dry-run-fade-in");let g=30*o.length<2e3?30*o.length:2e3;yield P((650+g)/s.displaySpeed)}))}function L(){return t(this,void 0,void 0,(function*(){s.displayProgress&&u.focusBox&&u.arrow&&u.tooltip&&u.arrowShadow&&u.tooltipShadow&&(yield P(500),u.focusBox.classList.add("dry-run-fade-out"),u.arrow.classList.add("dry-run-fade-out"),u.tooltip.classList.add("dry-run-fade-out"),u.arrowShadow.classList.add("dry-run-fade-out"),u.tooltipShadow.classList.add("dry-run-fade-out"),yield P(150),u.focusBox.remove(),u.tooltip.remove(),u.arrow.remove(),u.tooltipShadow.remove(),u.arrowShadow.remove())}))}function M(e){return t(this,void 0,void 0,(function*(){r.push(e);const o=`* ${e}`;s.logProgress&&console.log(o)}))}function A(e,o,i=s.continueOnFailure){return t(this,void 0,void 0,(function*(){l=!0;let t=`FAIL: ${e}`+(o?`: '${o}'`:"");i?t+=". Continuing execution.":(c=!1,t+=". Halting execution."),r.push(t),console.error(t),yield $(u.message,t,"error",!0),yield L()}))}function P(e){return t(this,void 0,void 0,(function*(){return new Promise((o=>setTimeout(o,e)))}))}}))}var n=self;for(var r in o)n[r]=o[r];o.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();
async function runDryRuns() {
  
await dryRun([
  'comment input[type="text"] Look at this thing!',
  'comment input[type="number"] Look at this other thing!',
]);

await dryRun([
  'log Tests starting',
  'value input[type="text"] Hello, world!',
  'value input[type="number"] 20',
  'click button',
  'exists pre hello',
  'write #far-down Back up we go!',
  'nav #',
  'log Next are custom functions',
  () => { console.log('This is logging from a custom function, next is a custom async function!') },
  async () => { await new Promise(resolve => setTimeout(() => { resolve() }, 300)) },
  'exists !.output processing...',
  'click button long process',
  'await !.output processing...',
  'await .output process complete',
], { message: 'Testing features', globalDelay: 100, displaySpeed: 2 });

await dryRun([
  'log Expect success: false',
  'click does-not-exist',
  'invalidkeyword test',
  () => { throw new Error('This function should error') },
  'exists !body',
  'await does-not-exist',
  'await body>main this text should not exist anywhere'
], {
  message: 'Testing error handling',
  continueOnFailure: true, awaitTimeout: 600,
  globalDelay: 50, displaySpeed: 2,
});

await dryRun([
  'log Expect success: false, should halt after next error',
  'click does-not-exist',
  'log If you see this, it did not work',
], { message: 'Testing graceful fail', globalDelay: 50, displaySpeed: 2 });

await dryRun([
  'append #progress  Done! Check the browser console for results.',
  'log All done!',
], { globalDelay: 0, logProgress: false, logResult: false });

  console.log('Done! See above for results.');
}
runDryRuns();
</script>
</body>

</html>
