var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{a(o.next(e))}catch(e){n(e)}}function l(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((o=o.apply(e,t||[])).next())}))};export function spaCheck(e,t={}){return __awaiter(this,void 0,void 0,(function*(){const i=[],o=Object.freeze(Object.assign(Object.assign({},{continueOnFailure:!1,globalDelay:500,awaitTimeout:15e3,logCollapse:!1,logResult:!0,logUpdates:!0,message:"",messageShowInDOM:!1,messageStyle:"font-size:24px; padding:10px; z-index:9999; position:fixed; top:0; right:10%; color:black; background-color:rgba(222,222,222,0.8);"}),t)),s=o.message?`[SPA Check] ${o.message}`:"[SPA Check]";let n,r=!1,l=!0;return this.main=e=>__awaiter(this,void 0,void 0,(function*(){yield this.messageStart();if(!this.validateInputs(e,t))return this.finish();for(const t of e){if(!l)return this.finish();yield this.sleep(o.globalDelay);try{yield this.do(t)}catch(e){this.error("Unexpected error: "+e.message)}}return this.finish()})),this.finish=()=>{const e=!r,t={success:e,log:i,message:o.message};return this.log(`Done, success: ${e}`),this.messageEnd(t),t},this.do=e=>__awaiter(this,void 0,void 0,(function*(){if("string"==typeof e)yield this.doActionString(e);else if("function"==typeof e)try{yield e(),this.log("Ran provided function")}catch(t){this.error("Error running provided function",t+"; function: "+e.toString())}else this.error("Action is not of type string or function, got",typeof e)})),this.doActionString=e=>__awaiter(this,void 0,void 0,(function*(){const t=e.substring(0,3);if("nav"===t){const t=e.split(" ")[1];t&&"#"===t[0]?(window.location.href=t,this.log(`Navigated to ${t}`)):this.error("Unexpected nav action, got",e)}else if("cli"===t){const[t,i,o]=this.argSplitComplex(e),s=this.getTargetText(i,o);if(o){const e=document.querySelectorAll(i),t=this.findTextInClickableChildElementRecursive(e,o);t?(t.click(),this.log(`Clicked element with text '${o}' inside ${i} (clicked on ${t.tagName.toLowerCase()})`)):this.error("Could not find selector to click",s)}else{const e=this.select(i);if(!e)return;e.click(),this.log(`Clicked ${i}`)}}else if("exi"===t){const[t,i,o]=this.argSplitComplex(e),s=this.getTargetText(i,o);let n=!1;if(o){const e=document.querySelectorAll(i);for(const t of e)if(this.checkIfElementContainsText(t,o)){n=!0;break}}else{document.querySelector(i)&&(n=!0)}n?this.log(`Did exist: ${s}`):this.error("Did not exist",s)}else if("val"===t){const[t,i,o]=this.argSplit(e);if(!this.select(i))return;this.select(i).value=o,this.log(`Set the value of ${i} to ${o}`)}else if("wri"===t||"app"===t){const[i,o,s]=this.argSplit(e),n=this.select(o);if(!n)return;"wri"===t?(n.textContent=s,this.log(`Wrote '${s}' over ${o}`)):(n.textContent+=s,this.log(`Appended '${s}' to ${o}`))}else if("log"===t){const[t,i]=e.split(/ (.*)/s);this.log(i)}else if("wai"===t){const[t,i]=e.split(" ");this.log(`Waiting ${Number(i)/1e3} second(s)`),yield this.sleep(Number(i))}else if("awa"===t){const[t,i,s]=this.argSplitComplex(e),n=o.awaitTimeout/o.globalDelay;let r=!1;const l=this.getTargetText(i,s);this.log(`Awaiting ${l}...`);for(let e=0;e<n;e++){if(s){const e=Array.from(document.querySelectorAll(i));for(const t of e)if(t&&t.textContent&&t.textContent.toLowerCase().includes(s.toLowerCase())){r=!0;break}}else{document.querySelector(i)&&(r=!0)}if(r)break;yield this.sleep(o.globalDelay)}r?this.log(`...Found ${l}`):this.error(`Timed out after ${o.awaitTimeout/1e3} second(s) awaiting`,l)}else""===e||this.error("Action string keyword not recognized, got",e)})),this.select=e=>{const t=document.querySelector(e);return t||this.error("CSS Selector not found",e),t},this.findTextInClickableChildElementRecursive=(e,t)=>{if(e.length<1)return;const i=t.toLowerCase();for(const o of e){if(this.checkIfElementContainsText(o,t)){const e=Array.from(o.childNodes).filter((e=>e.click));return 0===e.length?o:this.findTextInClickableChildElementRecursive(e,i)}}},this.checkIfElementContainsText=(e,t)=>{const i=t.toLowerCase(),o=e.textContent&&e.textContent.toLowerCase().includes(i),s="string"==typeof e.value&&e.value.toLocaleLowerCase().includes(i);return o||s},this.getTargetText=(e,t)=>`'${e}'`+(t?` containing text '${t}'`:""),this.argSplit=e=>{const t=e.split(/ ([^\s]+) (.*)/s);return t.length<3&&this.error(`Unexpected ${t[0]} input with data, got:`,e),t},this.argSplitComplex=e=>{const t=e.split(" ");return t.length>2?this.argSplit(e):t},this.messageStart=()=>__awaiter(this,void 0,void 0,(function*(){yield this.sleep(0),o.logUpdates&&(o.logCollapse?console.groupCollapsed(s):console.group(s)),n=o.messageShowInDOM&&o.message?this.displayMessageInDOM(o.message,o.messageStyle):void 0})),this.messageEnd=e=>{n&&n.remove();const t=o.logUpdates?"":s;o.logResult&&console.log(`${t} Result:`,e),o.logUpdates&&console.groupEnd()},this.displayMessageInDOM=(e,t)=>{var i;const o=document.createElement("p");return o.textContent=e,o.setAttribute("style",t),null===(i=document.querySelector("body"))||void 0===i||i.appendChild(o),o},this.validateInputs=(e,t)=>{let i=!0;return void 0===e?(i=!1,this.error("Missing required argument Action List","",!1)):Array.isArray(e)||(i=!1,this.error("Action list argument is not an Array","",!1)),void 0===t||"object"==typeof t&&!Array.isArray(t)||(i=!1,this.error("Options argument is not an Object","",!1)),i},this.log=e=>{i.push(e);const t=`* ${e}`;o.logUpdates&&console.log(t)},this.error=(e,t,s=o.continueOnFailure)=>{r=!0;let n=`FAIL: ${e}`+(t?`: '${t}'`:"");s?n+=". Continuing execution.":(l=!1,n+=". Halting execution."),i.push(n),console.error(n)},this.sleep=e=>new Promise((t=>setTimeout(t,e))),yield this.main(e)}))}
