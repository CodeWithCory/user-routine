var __awaiter=this&&this.__awaiter||function(t,e,i,o){return new(i||(i=Promise))((function(s,n){function r(t){try{l(o.next(t))}catch(t){n(t)}}function a(t){try{l(o.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((o=o.apply(t,e||[])).next())}))};export function spaCheck(t,e={}){return __awaiter(this,void 0,void 0,(function*(){const i={awaitTimeout:15e3,continueOnFailure:!1,displayMessage:!0,displayProgress:!0,globalDelay:500,logCollapse:!1,logProgress:!0,logResult:!0,message:"SPA Check",overrideCss:""},o=[],s=Object.freeze(Object.assign(Object.assign({},i),e)),n=s.message?`[SPA Check] ${s.message}`:"[SPA Check]";let r,a=!1,l=!0;const d={arrow:void 0,arrowShadow:void 0,focusBox:void 0,message:void 0,style:void 0,tooltip:void 0,tooltipShadow:void 0},c=150;return this.main=t=>__awaiter(this,void 0,void 0,(function*(){yield this.messageStart();if(!(yield this.validateInputs(t,e)))return this.finish();for(const e of t){if(!l)return this.finish();yield this.sleep(s.globalDelay);try{yield this.do(e)}catch(t){yield this.error("Unexpected error: "+t.message)}}return this.finish()})),this.do=t=>__awaiter(this,void 0,void 0,(function*(){if("string"==typeof t)yield this.doActionString(t);else if("function"==typeof t)try{yield this.performAction(t,"Running provided function"),this.log("Ran provided function")}catch(e){yield this.animateTooltipClose(),yield this.error("Error running provided function",e+"; function: "+t.toString())}else yield this.error("Action is not of type string or function, got",typeof t)})),this.doActionString=t=>__awaiter(this,void 0,void 0,(function*(){const e=t.substring(0,3);if("nav"===e){const e=t.split(" ")[1];e&&"#"===e[0]?(yield this.performAction((()=>{window.location.href=e}),`Navigating to ${e}`),this.log(`Navigated to ${e}`)):yield this.error("Unexpected nav action, got",t)}else if("cli"===e){const[e,i,o]=yield this.argSplitComplex(t),s=this.getTargetText(i,o);if(o){const t=this.selectorAll(i);r=void 0,this.findClickableElementWithTextRecursive(t,o),r?(yield this.performAction((()=>{r.click()}),`Clicking ${r.tagName.toLowerCase()} with text '${o}'`,r),this.log(`Clicked text '${o}' inside ${i} (clicked on ${r.tagName.toLowerCase()})`)):yield this.error("Could not find selector to click",s),r=void 0}else{const t=yield this.select(i);if(!t)return;yield this.performAction((()=>{t.click()}),`Clicking ${i}`,t),this.log(`Clicked ${i}`)}}else if("exi"===e){const[e,i,o]=yield this.argSplitComplex(t),s=this.getTargetText(i,o);let n,a=!1;if(o){const t=this.selectorAll(i);for(const e of t)if(this.checkIfElementContainsText(e,o)){a=!0,r=void 0,this.findClickableElementWithTextRecursive([e],o),n=r;break}}else{const t=this.selector(i);t&&(a=!0,n=t)}a?(yield this.animateTooltipOpen(n,`Confirmed exists: ${s}`,"info"),yield this.animateTooltipClose(),this.log(`Confirmed exists: ${s}`)):yield this.error("Did not exist",s),r=void 0}else if("val"===e){const[e,i,o]=yield this.argSplit(t),s=yield this.select(i);if(!s)return;yield this.performAction((()=>{s.value=o}),`Filling value of ${s.tagName.toLowerCase()}`,s),this.log(`Set the value of ${i} to ${o}`)}else if("wri"===e||"app"===e){const[i,o,s]=yield this.argSplit(t),n=yield this.select(o);if(!n)return;"wri"===e?(yield this.performAction((()=>{n.textContent=s}),`Writing over ${o}`,n),this.log(`Wrote '${s}' over ${o}`)):(yield this.performAction((()=>{n.textContent+=s}),`Appending text to ${o}`,n),this.log(`Appended '${s}' to ${o}`))}else if("log"===e){const[e,i]=t.split(/ (.*)/s);yield this.performAction((()=>{this.log(i)}),`${i}`)}else if("wai"===e){const[e,i]=t.split(" ");this.log(`Waiting ${Number(i)/1e3} second(s)`),yield this.performAction((()=>__awaiter(this,void 0,void 0,(function*(){yield this.sleep(Number(i))}))),`Waiting ${Number(i)/1e3} second(s)`)}else if("awa"===e){const[e,i,o]=yield this.argSplitComplex(t),n=s.awaitTimeout/s.globalDelay;let a,l=!1;const c=this.getTargetText(i,o);this.log(`Awaiting ${c}...`),yield this.animateTooltipOpen(d.message,`Awaiting ${c}...`,"info",!0);for(let t=0;t<n;t++){if(o){const t=Array.from(this.selectorAll(i.replace(/>>/g)));for(const e of t)if(e&&e.textContent&&e.textContent.toLowerCase().includes(o.toLowerCase())){l=!0,r=void 0,this.findClickableElementWithTextRecursive([e],o),a=r;break}}else{const t=this.selector(i);t&&(l=!0,a=t)}if(l)break;yield this.sleep(s.globalDelay)}yield this.animateTooltipClose(),l?(yield this.animateTooltipOpen(a,`...Found ${c}`,"info"),yield this.animateTooltipClose(),this.log(`...Found ${c}`)):yield this.error(`Timed out after ${s.awaitTimeout/1e3} second(s) awaiting`,c)}else""===t||(yield this.error("Action string keyword not recognized, got",t))})),this.performAction=(t,e,i)=>__awaiter(this,void 0,void 0,(function*(){let o=!1;i||(i=d.message?d.message:document.body,o=!0),yield this.animateTooltipOpen(i,e,"info",o),yield t(),yield this.animateTooltipClose()})),this.select=t=>__awaiter(this,void 0,void 0,(function*(){const e=this.selector(t);return e||(yield this.error("CSS Selector not found",t.replace(/>>/g," "))),e})),this.selector=t=>document.querySelector(t.replace(/>>/g," ")),this.selectorAll=t=>document.querySelectorAll(t.replace(/>>/g," ")),this.findClickableElementWithTextRecursive=(t,e)=>{for(const i of t){if(!this.checkIfElementContainsText(i,e))continue;this.checkIfElementIsClickable(i)&&(r=i);const t=Array.from(i.childNodes).filter((t=>{if(this.checkIfElementIsClickable(t))return t}));this.findClickableElementWithTextRecursive(t,e)}},this.checkIfElementIsClickable=t=>t.click&&"SCRIPT"!==t.tagName,this.checkIfElementContainsText=(t,e)=>{const i=e.toLowerCase(),o=t.textContent&&t.textContent.toLowerCase().includes(i),s="string"==typeof t.value&&t.value.toLocaleLowerCase().includes(i);return o||s},this.getTargetText=(t,e)=>`'${t.replace(/>>/g," ")}'`+(e?` containing text '${e}'`:""),this.argSplit=t=>__awaiter(this,void 0,void 0,(function*(){const e=t.split(/ ([^\s]+) (.*)/s);return e.length<3&&(yield this.error(`Unexpected ${e[0]} input with data, got:`,t)),e[1]=e[1].replace(/>>/g," "),e})),this.argSplitComplex=t=>__awaiter(this,void 0,void 0,(function*(){const e=t.split(" ");return e.length>2?yield this.argSplit(t):(e[1]=e[1].replace(/>>/g," "),e)})),this.messageStart=()=>__awaiter(this,void 0,void 0,(function*(){(s.displayMessage||s.displayProgress)&&this.addCss(),yield this.sleep(0),s.logProgress&&(s.logCollapse?console.groupCollapsed(n):console.group(n)),this.displayMessageInDOM(s.message)})),this.messageEnd=t=>{d.message&&d.message.remove(),d.style&&d.style.remove();const e=s.logProgress?"":n;s.logResult&&console.log(`${e} Result:`,t),s.logProgress&&console.groupEnd()},this.finish=()=>{this.ensureCleanDOM();const t=!a,e={success:t,log:o,message:s.message};return this.log(`Done, success: ${t}`),this.messageEnd(e),e},this.ensureCleanDOM=()=>{for(const t in d)d[t]&&d[t].parentNode&&d[t].remove&&d[t].remove()},this.addCss=()=>{var t;d.style=document.createElement("style"),d.style.textContent="\n      .spa-check-message {\n        font: 20px Georgia !important;\n        padding: 18px 12px 6px 12px !important;\n        z-index: 9999 !important;\n        position: fixed !important;\n        top: 0 !important;\n        right: 10% !important;\n        color: black !important;\n        background-color: rgba(245,245,245,0.9) !important;\n        text-align: right !important;\n        border-radius: 0 0 12px 12px !important;\n        max-width: 80vw !important;\n        overflow: hidden !important;\n        white-space: nowrap !important;\n        text-overflow: ellipsis !important;\n        border: 2px solid rgb(180,180,180) !important;\n        border-top: 0 !important;\n      }\n      .spa-check-message>.spa-check-attribution {\n        font-size: 12px !important;\n        color: dimgray !important;\n      }\n      .spa-check-focus-box {\n        z-index: 9997 !important;\n        visibility: hidden !important;\n        position: absolute !important;\n        background-color: rgba(255,255,255,0.2) !important;\n        border: 2px solid white !important;\n        box-shadow: 0 0 0 2px rgb(0,0,0) !important;\n      }\n      .spa-check-tooltip {\n        z-index: 9999 !important;\n        visibility: hidden !important;\n        font: 14px Georgia !important;\n        position: absolute !important;\n        background-color: rgb(245,245,245) !important;\n        color: black !important;\n        text-align: center !important;\n        padding: 10px !important;\n        border-radius: 10px !important;\n        max-width: 200px !important;\n      }\n      .spa-check-tooltip-error {\n        color: darkred !important;\n      }\n      .spa-check-arrow {\n        z-index: 9999 !important;\n        visibility: hidden !important;\n        width: 0 !important;\n        height: 0 !important;\n        position: absolute !important;\n        border-left: 10px solid transparent !important;\n        border-right: 10px solid transparent !important;\n        border-bottom: 10px solid rgb(245,245,245) !important; \n      }\n      .spa-check-arrow-shadow {\n        z-index: 9998 !important;\n        border-left: 14px solid transparent !important;\n        border-right: 14px solid transparent !important;\n        border-bottom: 14px solid rgb(180,180,180) !important;\n        margin: -3px 0 0 -4px !important;\n      }\n      .spa-check-tooltip-shadow {\n        z-index: 9998 !important;\n        color: transparent !important;\n        border: 2px solid rgb(180,180,180) !important;\n        background-color: rgb(180,180,180) !important;\n        margin: -2px 0 0 -2px !important;\n        border-radius: 12px !important;\n      }\n      .spa-check-fade-in {\n        visibility: visible !important;\n        animation: spaCheckfadeIn 150ms !important; \n      }\n      .spa-check-fade-out {\n        opacity: 0 !important;\n        animation: spaCheckfadeOut 150ms !important; \n      }\n      @keyframes spaCheckfadeIn {\n        0% { opacity: 0 !important; }\n        100% { opacity: 1 !important; }\n      }\n      @keyframes spaCheckfadeOut {\n        0% { opacity: 1 !important; }\n        100% { opacity: 0 !important; }\n      }\n    ",d.style.textContent+=s.overrideCss,null===(t=this.selector("body"))||void 0===t||t.appendChild(d.style)},this.displayMessageInDOM=t=>{var e;d.message=document.createElement("div");const o=t===i.message?"":'<div class="spa-check-attribution">SPA Check</div>';d.message.innerHTML=t+o,d.message.classList.add("spa-check-message"),s.displayMessage||(d.message.style.visibility="hidden"),null===(e=this.selector("body"))||void 0===e||e.appendChild(d.message)},this.animateTooltipOpen=(t,e,i="info",o)=>__awaiter(this,void 0,void 0,(function*(){if(!s.displayProgress)return;const n=document.body.getBoundingClientRect(),r=t.getBoundingClientRect(),a=o?0:window.pageYOffset||t.scrollTop||document.body.scrollTop,l=window.pageXOffset||t.scrollLeft||document.body.scrollLeft;d.focusBox=document.createElement("div"),d.focusBox.classList.add("spa-check-focus-box"),d.arrow=document.createElement("div"),d.arrow.classList.add("spa-check-arrow"),d.tooltip=document.createElement("div"),d.tooltip.classList.add("spa-check-tooltip"),"error"===i&&d.tooltip.classList.add("spa-check-tooltip-error"),d.tooltip.textContent=e.replace(/>>/g," "),document.body.appendChild(d.focusBox),document.body.appendChild(d.arrow),document.body.appendChild(d.tooltip);const c=d.tooltip.getBoundingClientRect().width;let p=r.bottom+10+a,h=r.left+l+r.width/2-10,m=r.left+l+r.width/2-c/2;h<8?h=8:n.right+l-h<20&&(h=n.right+l-20),m<0&&(m=0),o&&(d.focusBox.style.display="none",d.arrow.style.display="none",d.tooltip.style.position="fixed",h-=l,p-=5,m-=l),d.arrow.style.top=String(r.bottom+a+2)+"px",d.arrow.style.left=String(h)+"px",d.tooltip.style.top=String(p+2)+"px",d.tooltip.style.left=String(m)+"px",d.focusBox.style.top=String(r.top+a-2)+"px",d.focusBox.style.left=String(r.left+l-2)+"px",d.focusBox.style.width=String(r.width)+"px",d.focusBox.style.height=String(r.height)+"px",d.arrowShadow=d.arrow.cloneNode(!0),d.tooltipShadow=d.tooltip.cloneNode(!0),d.arrowShadow.classList.add("spa-check-arrow-shadow"),d.tooltipShadow.classList.add("spa-check-tooltip-shadow"),document.body.appendChild(d.arrowShadow),document.body.appendChild(d.tooltipShadow),yield this.scrollIntoViewIfNeeded(t),d.focusBox.classList.add("spa-check-fade-in"),d.arrowShadow.classList.add("spa-check-fade-in"),d.tooltipShadow.classList.add("spa-check-fade-in"),d.arrow.classList.add("spa-check-fade-in"),d.tooltip.classList.add("spa-check-fade-in");const g=30*e.length<2e3?30*e.length:2e3;yield this.sleep(650+g)})),this.animateTooltipClose=()=>__awaiter(this,void 0,void 0,(function*(){if(!(s.displayProgress&&d.focusBox&&d.arrow&&d.tooltip&&d.arrowShadow&&d.tooltipShadow))return;yield this.sleep(500),d.focusBox.classList.add("spa-check-fade-out"),d.arrow.classList.add("spa-check-fade-out"),d.tooltip.classList.add("spa-check-fade-out"),d.arrowShadow.classList.add("spa-check-fade-out"),d.tooltipShadow.classList.add("spa-check-fade-out"),yield this.sleep(c),d.focusBox.remove(),d.tooltip.remove(),d.arrow.remove(),d.tooltipShadow.remove(),d.arrowShadow.remove()})),this.scrollIntoViewIfNeeded=t=>__awaiter(this,void 0,void 0,(function*(){this.checkVisible(t)||(t.scrollIntoView({behavior:"smooth"}),yield this.sleep(700))})),this.checkVisible=t=>{var e=t.getBoundingClientRect(),i=Math.max(document.documentElement.clientHeight,window.innerHeight);return!(e.bottom<0||e.top-i>=0)},this.validateInputs=(t,e)=>__awaiter(this,void 0,void 0,(function*(){let i=!0;return void 0===t?(i=!1,yield this.error("Missing required argument Action List","",!1)):Array.isArray(t)||(i=!1,yield this.error("Action list argument is not an Array","",!1)),void 0===e||"object"==typeof e&&!Array.isArray(e)||(i=!1,yield this.error("Options argument is not an Object","",!1)),i})),this.log=t=>{o.push(t);const e=`* ${t}`;s.logProgress&&console.log(e)},this.error=(t,e,i=s.continueOnFailure)=>__awaiter(this,void 0,void 0,(function*(){a=!0;let s=`FAIL: ${t}`+(e?`: '${e}'`:"");i?s+=". Continuing execution.":(l=!1,s+=". Halting execution."),o.push(s),console.error(s),yield this.animateTooltipOpen(d.message,s,"error",!0),yield this.animateTooltipClose()})),this.sleep=t=>new Promise((e=>setTimeout(e,t))),yield this.main(t)}))}
