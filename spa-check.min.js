var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(o,n){function r(e){try{a(s.next(e))}catch(e){n(e)}}function l(e){try{a(s.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((s=s.apply(e,t||[])).next())}))};export function spaCheck(e,t={}){return __awaiter(this,void 0,void 0,(function*(){const i=[],s=Object.freeze(Object.assign(Object.assign({},{continueOnFailure:!1,globalDelay:500,awaitTimeout:15e3,logCollapse:!1,logResult:!0,logUpdates:!0,message:"",messageShowInDOM:!1,messageStyle:"font-size:24px; padding:10px; z-index:9999; position:fixed; top:0; right:10%; color:black; background-color:rgba(222,222,222,0.8);"}),t)),o=s.message?`[SPA Check] ${s.message}`:"[SPA Check]";let n,r,l=!1,a=!0;return this.main=e=>__awaiter(this,void 0,void 0,(function*(){yield this.messageStart();if(!this.validateInputs(e,t))return this.finish();for(const t of e){if(!a)return this.finish();yield this.sleep(s.globalDelay);try{yield this.do(t)}catch(e){this.error("Unexpected error: "+e.message)}}return this.finish()})),this.finish=()=>{const e=!l,t={success:e,log:i,message:s.message};return this.log(`Done, success: ${e}`),this.messageEnd(t),t},this.do=e=>__awaiter(this,void 0,void 0,(function*(){if("string"==typeof e)yield this.doActionString(e);else if("function"==typeof e)try{yield e(),this.log("Ran provided function")}catch(t){this.error("Error running provided function",t+"; function: "+e.toString())}else this.error("Action is not of type string or function, got",typeof e)})),this.doActionString=e=>__awaiter(this,void 0,void 0,(function*(){const t=e.substring(0,3);if("nav"===t){const t=e.split(" ")[1];t&&"#"===t[0]?(window.location.href=t,this.log(`Navigated to ${t}`)):this.error("Unexpected nav action, got",e)}else if("cli"===t){const[t,i,s]=this.argSplitComplex(e),o=this.getTargetText(i,s);if(s){const e=document.querySelectorAll(i);r=void 0,this.findClickableElementWithTextRecursive(e,s),r?(r.click(),this.log(`Clicked text '${s}' inside ${i} (clicked on ${r.tagName.toLowerCase()})`)):this.error("Could not find selector to click",o),r=void 0}else{const e=this.select(i);if(!e)return;e.click(),this.log(`Clicked ${i}`)}}else if("exi"===t){const[t,i,s]=this.argSplitComplex(e),o=this.getTargetText(i,s);let n=!1;if(s){const e=document.querySelectorAll(i);for(const t of e)if(this.checkIfElementContainsText(t,s)){n=!0;break}}else{document.querySelector(i)&&(n=!0)}n?this.log(`Did exist: ${o}`):this.error("Did not exist",o)}else if("val"===t){const[t,i,s]=this.argSplit(e);if(!this.select(i))return;this.select(i).value=s,this.log(`Set the value of ${i} to ${s}`)}else if("wri"===t||"app"===t){const[i,s,o]=this.argSplit(e),n=this.select(s);if(!n)return;"wri"===t?(n.textContent=o,this.log(`Wrote '${o}' over ${s}`)):(n.textContent+=o,this.log(`Appended '${o}' to ${s}`))}else if("log"===t){const[t,i]=e.split(/ (.*)/s);this.log(i)}else if("wai"===t){const[t,i]=e.split(" ");this.log(`Waiting ${Number(i)/1e3} second(s)`),yield this.sleep(Number(i))}else if("awa"===t){const[t,i,o]=this.argSplitComplex(e),n=s.awaitTimeout/s.globalDelay;let r=!1;const l=this.getTargetText(i,o);this.log(`Awaiting ${l}...`);for(let e=0;e<n;e++){if(o){const e=Array.from(document.querySelectorAll(i));for(const t of e)if(t&&t.textContent&&t.textContent.toLowerCase().includes(o.toLowerCase())){r=!0;break}}else{document.querySelector(i)&&(r=!0)}if(r)break;yield this.sleep(s.globalDelay)}r?this.log(`...Found ${l}`):this.error(`Timed out after ${s.awaitTimeout/1e3} second(s) awaiting`,l)}else""===e||this.error("Action string keyword not recognized, got",e)})),this.select=e=>{const t=document.querySelector(e);return t||this.error("CSS Selector not found",e),t},this.findClickableElementWithTextRecursive=(e,t)=>{for(const i of e){if(!this.checkIfElementContainsText(i,t))continue;this.checkIfElementIsClickable(i)&&(r=i);const e=Array.from(i.childNodes).filter((e=>{if(this.checkIfElementIsClickable(e))return e}));this.findClickableElementWithTextRecursive(e,t)}},this.checkIfElementIsClickable=e=>e.click&&"SCRIPT"!==e.tagName,this.checkIfElementContainsText=(e,t)=>{const i=t.toLowerCase(),s=e.textContent&&e.textContent.toLowerCase().includes(i),o="string"==typeof e.value&&e.value.toLocaleLowerCase().includes(i);return s||o},this.getTargetText=(e,t)=>`'${e}'`+(t?` containing text '${t}'`:""),this.argSplit=e=>{const t=e.split(/ ([^\s]+) (.*)/s);return t.length<3&&this.error(`Unexpected ${t[0]} input with data, got:`,e),t},this.argSplitComplex=e=>{const t=e.split(" ");return t.length>2?this.argSplit(e):t},this.messageStart=()=>__awaiter(this,void 0,void 0,(function*(){yield this.sleep(0),s.logUpdates&&(s.logCollapse?console.groupCollapsed(o):console.group(o)),n=s.messageShowInDOM&&s.message?this.displayMessageInDOM(s.message,s.messageStyle):void 0})),this.messageEnd=e=>{n&&n.remove();const t=s.logUpdates?"":o;s.logResult&&console.log(`${t} Result:`,e),s.logUpdates&&console.groupEnd()},this.displayMessageInDOM=(e,t)=>{var i;const s=document.createElement("p");return s.textContent=e,s.setAttribute("style",t),null===(i=document.querySelector("body"))||void 0===i||i.appendChild(s),s},this.validateInputs=(e,t)=>{let i=!0;return void 0===e?(i=!1,this.error("Missing required argument Action List","",!1)):Array.isArray(e)||(i=!1,this.error("Action list argument is not an Array","",!1)),void 0===t||"object"==typeof t&&!Array.isArray(t)||(i=!1,this.error("Options argument is not an Object","",!1)),i},this.log=e=>{i.push(e);const t=`* ${e}`;s.logUpdates&&console.log(t)},this.error=(e,t,o=s.continueOnFailure)=>{l=!0;let n=`FAIL: ${e}`+(t?`: '${t}'`:"");o?n+=". Continuing execution.":(a=!1,n+=". Halting execution."),i.push(n),console.error(n)},this.sleep=e=>new Promise((t=>setTimeout(t,e))),yield this.main(e)}))}
