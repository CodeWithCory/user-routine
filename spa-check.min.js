var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{l(o.next(e))}catch(e){n(e)}}function a(e){try{l(o.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((o=o.apply(e,t||[])).next())}))};export function spaCheck(e,t={}){return __awaiter(this,void 0,void 0,(function*(){const i={awaitTimeout:15e3,continueOnFailure:!1,displayMessage:!0,displayProgress:!0,displaySpeed:1,globalDelay:500,logCollapse:!1,logProgress:!0,logResult:!0,message:"SPA Check",overrideCss:"",separator:" "},o=[],s=Object.freeze(Object.assign(Object.assign({},i),t)),n=s.message?`[SPA Check] ${s.message}`:"[SPA Check]";let r,a=!1,l=!0;const d={arrow:void 0,arrowShadow:void 0,focusBox:void 0,message:void 0,style:void 0,tooltip:void 0,tooltipShadow:void 0},c=150;return this.main=e=>__awaiter(this,void 0,void 0,(function*(){yield this.messageStart();if(!(yield this.validateInputs(e,t)))return this.finish();for(const t of e){if(!l)return this.finish();yield this.sleep(s.globalDelay);try{yield this.do(t)}catch(e){yield this.error("Unexpected error: "+e.message)}}return this.finish()})),this.do=e=>__awaiter(this,void 0,void 0,(function*(){if("string"==typeof e)yield this.doActionString(e);else if("function"==typeof e)try{yield this.performAction(e,"Running provided function"),this.log("Ran provided function")}catch(t){yield this.animateTooltipClose(),yield this.error("Error running provided function",t+"; function: "+e.toString())}else yield this.error("Action is not of type string or function, got",typeof e)})),this.doActionString=e=>__awaiter(this,void 0,void 0,(function*(){const t=e.substring(0,3);if("nav"===t){const t=e.split(s.separator)[1];t&&"#"===t[0]?(yield this.performAction((()=>{window.location.href=t}),`Navigating to ${t}`),this.log(`Navigated to ${t}`)):yield this.error("Unexpected nav action, got",e)}else if("cli"===t){const[t,i,o]=yield this.argSplitComplex(e),s=this.getTargetText(i,o);if(o){const e=this.selectorAll(i);r=void 0,this.findClickableElementWithTextRecursive(e,o),r?(yield this.performAction((()=>{r.click()}),`Clicking ${r.tagName.toLowerCase()} with text '${o}'`,r),this.log(`Clicked text '${o}' inside ${i} (clicked on ${r.tagName.toLowerCase()})`)):yield this.error("Could not find selector to click",s),r=void 0}else{const e=yield this.select(i);if(!e)return;yield this.performAction((()=>{e.click()}),`Clicking ${i}`,e),this.log(`Clicked ${i}`)}}else if("exi"===t){let[t,i,o]=yield this.argSplitComplex(e),s=!1;"!"===i[0]&&(i=i.substring(1),s=!0);const n=this.getTargetText(i,o);let a,l=!1;if(o){const e=this.selectorAll(i);for(const t of e)if(this.checkIfElementContainsText(t,o)){l=!0,r=void 0,this.findClickableElementWithTextRecursive([t],o),a=r;break}}else{const e=this.selector(i);e&&(l=!0,a=e)}l&&!s?(yield this.animateTooltipOpen(a,`Confirmed exists: ${n}`,"info"),yield this.animateTooltipClose(),this.log(`Confirmed exists: ${n}`)):l||s?l&&s?(yield this.animateTooltipOpen(a,`Confirmed exists: ${n}`,"error"),yield this.animateTooltipClose(),yield this.error(`Confirmed exists: ${n}`)):!l&&s&&(yield this.animateTooltipOpen(d.message,`Confirmed does not exist: ${n}`,"info",!0),yield this.animateTooltipClose(),this.log(`Confirmed does not exist: ${n}`)):yield this.error("Did not exist",n),r=void 0}else if("val"===t){const[t,i,o]=yield this.argSplit(e),s=yield this.select(i);if(!s)return;yield this.performAction((()=>{s.value=o,s.dispatchEvent(new InputEvent("input"))}),`Filling value of ${s.tagName.toLowerCase()}`,s),this.log(`Set the value of ${i} to ${o}`)}else if("wri"===t||"app"===t){const[i,o,s]=yield this.argSplit(e),n=yield this.select(o);if(!n)return;"wri"===t?(yield this.performAction((()=>{n.textContent=s}),`Writing over ${o}`,n),this.log(`Wrote '${s}' over ${o}`)):(yield this.performAction((()=>{n.textContent+=s}),`Appending text to ${o}`,n),this.log(`Appended '${s}' to ${o}`))}else if("log"===t){const[t,i]=e.split(/ (.*)/s);yield this.performAction((()=>{this.log(i)}),`${i}`)}else if("wai"===t){const[t,i]=e.split(s.separator);this.log(`Waiting ${Number(i)/1e3} second(s)`),yield this.performAction((()=>__awaiter(this,void 0,void 0,(function*(){yield this.sleep(Number(i))}))),`Waiting ${Number(i)/1e3} second(s)`)}else if("awa"===t){let[t,i,o]=yield this.argSplitComplex(e),n=!1;"!"===i[0]&&(i=i.substring(1),n=!0);const a=s.awaitTimeout/s.globalDelay;let l,c=!1;const h=this.getTargetText(i,o);this.log(`Awaiting ${h}...`);const p=n?`Awaiting ${h} to not exist...`:`Awaiting ${h}...`;yield this.animateTooltipOpen(d.message,p,"info",!0);for(let e=0;e<a;e++){if(o){const e=Array.from(this.selectorAll(i.replace(/>>/g)));for(const t of e)if(t&&t.textContent&&t.textContent.toLowerCase().includes(o.toLowerCase())){c=!0,r=void 0,this.findClickableElementWithTextRecursive([t],o),l=r;break}}else{const e=this.selector(i);e&&(c=!0,l=e)}if(c&&!n)break;if(!c&&n)break;c=!1,yield this.sleep(s.globalDelay)}yield this.animateTooltipClose(),c&&!n?(yield this.animateTooltipOpen(l,`...Found ${h}`,"info"),yield this.animateTooltipClose(),this.log(`...Found ${h}`)):c||n?c&&n?(yield this.animateTooltipOpen(l,`...Timed out awaiting ${h} to not exist`,"error"),yield this.animateTooltipClose(),yield this.error(`...Timed out awaiting ${h} to not exist`)):!c&&n&&this.log(`...${h} disappeared`):yield this.error(`Timed out after ${s.awaitTimeout/1e3} second(s) awaiting`,h)}else""===e||(yield this.error("Action string keyword not recognized, got",e))})),this.performAction=(e,t,i)=>__awaiter(this,void 0,void 0,(function*(){let o=!1;i||(i=d.message?d.message:document.body,o=!0),yield this.animateTooltipOpen(i,t,"info",o),yield e(),yield this.animateTooltipClose()})),this.select=e=>__awaiter(this,void 0,void 0,(function*(){const t=this.selector(e);return t||(yield this.error("CSS Selector not found",e.replace(/>>/g," "))),t})),this.selector=e=>document.querySelector(e.replace(/>>/g," ")),this.selectorAll=e=>document.querySelectorAll(e.replace(/>>/g," ")),this.findClickableElementWithTextRecursive=(e,t)=>{for(const i of e){if(!this.checkIfElementContainsText(i,t))continue;this.checkIfElementIsClickable(i)&&(r=i);const e=Array.from(i.childNodes).filter((e=>{if(this.checkIfElementIsClickable(e))return e}));this.findClickableElementWithTextRecursive(e,t)}},this.checkIfElementIsClickable=e=>e.click&&"SCRIPT"!==e.tagName,this.checkIfElementContainsText=(e,t)=>{const i=t.toLowerCase(),o=e.textContent&&e.textContent.toLowerCase().includes(i),s="string"==typeof e.value&&e.value.toLocaleLowerCase().includes(i);return o||s},this.getTargetText=(e,t)=>`'${e}'`+(t?` containing text '${t}'`:""),this.argSplit=e=>__awaiter(this,void 0,void 0,(function*(){if(" "!==s.separator)return e.split(s.separator);const t=e.split(/ ([^\s]+) (.*)/s);return t.length<3&&(yield this.error(`Unexpected ${t[0]} input with data, got:`,e)),t[1]=t[1].replace(/>>/g," "),t})),this.argSplitComplex=e=>__awaiter(this,void 0,void 0,(function*(){const t=e.split(s.separator);return" "!==s.separator?t:t.length>2?yield this.argSplit(e):(t[1]=t[1].replace(/>>/g," "),t)})),this.messageStart=()=>__awaiter(this,void 0,void 0,(function*(){(s.displayMessage||s.displayProgress)&&this.addCss(),yield this.sleep(0),s.logProgress&&(s.logCollapse?console.groupCollapsed(n):console.group(n)),this.displayMessageInDOM(s.message)})),this.messageEnd=e=>{d.message&&d.message.remove(),d.style&&d.style.remove();const t=s.logProgress?"":n;s.logResult&&console.log(`${t} Result:`,e),s.logProgress&&console.groupEnd()},this.finish=()=>{this.ensureCleanDOM();const e=!a,t={success:e,log:o,message:s.message};return this.log(`Done, success: ${e}`),this.messageEnd(t),t},this.ensureCleanDOM=()=>{for(const e in d)d[e]&&d[e].parentNode&&d[e].remove&&d[e].remove()},this.addCss=()=>{var e;d.style=document.createElement("style"),d.style.textContent="\n      body > .spa-check-message {\n        font: 20px Georgia;\n        padding: 18px 12px 6px 12px;\n        z-index: 9999;\n        position: fixed;\n        top: 0;\n        right: 10%;\n        color: black;\n        background-color: rgba(250,250,250,0.8);\n        text-align: right;\n        border-radius: 0 0 12px 12px;\n        max-width: 80vw;\n        overflow: hidden;\n        white-space: nowrap;\n        text-overflow: ellipsis;\n        border: 2px solid rgb(180,180,180);\n        border-top: 0;\n      }\n      body > .spa-check-message>.spa-check-attribution {\n        font-size: 12px;\n        color: dimgray;\n      }\n      body > .spa-check-focus-box {\n        z-index: 9997;\n        visibility: hidden;\n        position: absolute;\n        background-color: rgba(255,255,255,0.2);\n        border: 2px solid white;\n        box-shadow: 0 0 0 2px rgb(0,0,0);\n      }\n      body > .spa-check-tooltip {\n        z-index: 9999;\n        visibility: hidden;\n        font: 14px Georgia;\n        position: absolute;\n        background-color: rgb(245,245,245);\n        color: black;\n        text-align: center;\n        padding: 10px;\n        border-radius: 10px;\n        max-width: 200px;\n      }\n      body > .spa-check-tooltip-error {\n        color: darkred;\n      }\n      body > .spa-check-arrow {\n        z-index: 9999;\n        visibility: hidden;\n        width: 0;\n        height: 0;\n        position: absolute;\n        border-left: 10px solid transparent;\n        border-right: 10px solid transparent;\n        border-bottom: 10px solid rgb(245,245,245); \n      }\n      body > .spa-check-arrow-shadow {\n        z-index: 9998;\n        border-left: 14px solid transparent;\n        border-right: 14px solid transparent;\n        border-bottom: 14px solid rgb(180,180,180);\n        margin: -3px 0 0 -4px;\n      }\n      body > .spa-check-tooltip-shadow {\n        z-index: 9998;\n        color: transparent;\n        border: 2px solid rgb(180,180,180);\n        background-color: rgb(180,180,180);\n        margin: -2px 0 0 -2px;\n        border-radius: 12px;\n      }\n      body > .spa-check-fade-in {\n        visibility: visible;\n        animation: spaCheckfadeIn 150ms; \n      }\n      body > .spa-check-fade-out {\n        opacity: 0;\n        animation: spaCheckfadeOut 150ms; \n      }\n      @keyframes spaCheckfadeIn {\n        0% { opacity: 0; }\n        100% { opacity: 1; }\n      }\n      @keyframes spaCheckfadeOut {\n        0% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n    ",d.style.textContent+=s.overrideCss,null===(e=this.selector("body"))||void 0===e||e.appendChild(d.style)},this.displayMessageInDOM=e=>{var t;d.message=document.createElement("div");const o=e===i.message?"":'<div class="spa-check-attribution">SPA Check</div>';d.message.innerHTML=e+o,d.message.classList.add("spa-check-message"),s.displayMessage||(d.message.style.visibility="hidden"),null===(t=this.selector("body"))||void 0===t||t.appendChild(d.message)},this.animateTooltipOpen=(e,t,i="info",o)=>__awaiter(this,void 0,void 0,(function*(){if(!s.displayProgress)return;const n=document.body.getBoundingClientRect(),r=e.getBoundingClientRect(),a=o?0:window.pageYOffset||e.scrollTop||document.body.scrollTop,l=window.pageXOffset||e.scrollLeft||document.body.scrollLeft;d.focusBox=document.createElement("div"),d.focusBox.classList.add("spa-check-focus-box"),d.arrow=document.createElement("div"),d.arrow.classList.add("spa-check-arrow"),d.tooltip=document.createElement("div"),d.tooltip.classList.add("spa-check-tooltip"),"error"===i&&d.tooltip.classList.add("spa-check-tooltip-error"),d.tooltip.textContent=t.replace(/>>/g," "),document.body.appendChild(d.focusBox),document.body.appendChild(d.arrow),document.body.appendChild(d.tooltip);const c=d.tooltip.getBoundingClientRect().width;let h=r.bottom+10+a,p=r.left+l+r.width/2-10,g=r.left+l+r.width/2-c/2;p<8?p=8:n.right+l-p<20&&(p=n.right+l-20),g<0&&(g=0),o&&(d.focusBox.style.display="none",d.arrow.style.display="none",d.tooltip.style.position="fixed",p-=l,h-=5,g-=l),d.arrow.style.top=String(r.bottom+a+2)+"px",d.arrow.style.left=String(p)+"px",d.tooltip.style.top=String(h+2)+"px",d.tooltip.style.left=String(g)+"px",d.focusBox.style.top=String(r.top+a-2)+"px",d.focusBox.style.left=String(r.left+l-2)+"px",d.focusBox.style.width=String(r.width)+"px",d.focusBox.style.height=String(r.height)+"px",d.arrowShadow=d.arrow.cloneNode(!0),d.tooltipShadow=d.tooltip.cloneNode(!0),d.arrowShadow.classList.add("spa-check-arrow-shadow"),d.tooltipShadow.classList.add("spa-check-tooltip-shadow"),document.body.appendChild(d.arrowShadow),document.body.appendChild(d.tooltipShadow),yield this.scrollIntoViewIfNeeded(e),d.focusBox.classList.add("spa-check-fade-in"),d.arrowShadow.classList.add("spa-check-fade-in"),d.tooltipShadow.classList.add("spa-check-fade-in"),d.arrow.classList.add("spa-check-fade-in"),d.tooltip.classList.add("spa-check-fade-in");let f=30*t.length<2e3?30*t.length:2e3;yield this.sleep((650+f)/s.displaySpeed)})),this.animateTooltipClose=()=>__awaiter(this,void 0,void 0,(function*(){if(!(s.displayProgress&&d.focusBox&&d.arrow&&d.tooltip&&d.arrowShadow&&d.tooltipShadow))return;yield this.sleep(500),d.focusBox.classList.add("spa-check-fade-out"),d.arrow.classList.add("spa-check-fade-out"),d.tooltip.classList.add("spa-check-fade-out"),d.arrowShadow.classList.add("spa-check-fade-out"),d.tooltipShadow.classList.add("spa-check-fade-out"),yield this.sleep(c),d.focusBox.remove(),d.tooltip.remove(),d.arrow.remove(),d.tooltipShadow.remove(),d.arrowShadow.remove()})),this.scrollIntoViewIfNeeded=e=>__awaiter(this,void 0,void 0,(function*(){this.checkVisible(e)||(e.scrollIntoView({behavior:"smooth"}),yield this.sleep(700))})),this.checkVisible=e=>{var t=e.getBoundingClientRect(),i=Math.max(document.documentElement.clientHeight,window.innerHeight);return!(t.bottom<0||t.top-i>=0)},this.validateInputs=(e,t)=>__awaiter(this,void 0,void 0,(function*(){let i=!0;return void 0===e?(i=!1,yield this.error("Missing required argument Action List","",!1)):Array.isArray(e)||(i=!1,yield this.error("Action list argument is not an Array","",!1)),void 0===t||"object"==typeof t&&!Array.isArray(t)||(i=!1,yield this.error("Options argument is not an Object","",!1)),i})),this.log=e=>{o.push(e);const t=`* ${e}`;s.logProgress&&console.log(t)},this.error=(e,t,i=s.continueOnFailure)=>__awaiter(this,void 0,void 0,(function*(){a=!0;let s=`FAIL: ${e}`+(t?`: '${t}'`:"");i?s+=". Continuing execution.":(l=!1,s+=". Halting execution."),o.push(s),console.error(s),yield this.animateTooltipOpen(d.message,s,"error",!0),yield this.animateTooltipClose()})),this.sleep=e=>new Promise((t=>setTimeout(t,e))),yield this.main(e)}))}
